#!/usr/bin/env python3
"""Test datasets"""

import boards
import datasets
import jax
import numpy as np


def test_sparse():
  steps = 7
  batch = 5
  dataset = datasets.sparse_dataset(counts=(4,5))
  assert dataset.batches(batch=batch) == 12544 // batch

  # Test correctness
  correct = {116937326592:1,5489557504:0,22805039391180210:1,281475937533952:1,117110734875:1,5629499581988900:1,2462343096264822339:-1,12525080152203:-1,1231171548132409609:0,615585774082260998:1,58458799865868:1,116700217344:-1,700955623424:0,9406870388736:1,1367996566099525713:0,45599294124799029:0,6386616959057:-1,100859961:1,45608339607259275:1,3693514644540751926:1,3694640544304660642:0,410390516107838898:1,9393390813265:0,2533274790396849:1,7599824523362466:0,616430199010492416:1,68961369294112262:-1,45598946515558956:0,6339377102929:-1,3401619406902:0,27866031284881547:0,7459:1,236223792805:0,3131318075398:0,15202779773542254:0}
  datasets.dataset_correctness_test(dataset, correct=correct, steps=steps, batch=batch)

  # Test that each epoch is different
  n = dataset.batches(batch=batch)
  data = [b for _, b in zip(range(3*n), dataset.forever(batch=batch))]
  assert np.any(data[0]['value'] != data[n]['value'])


if __name__ == '__main__':
  test_sparse()
